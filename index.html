<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trang ƒê·ªçc Truy·ªán</title>
  <style>
    :root { --primary:#2d89ef; }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      color: #333;
    }
    header {
      background: var(--primary);
      color: white;
      padding: 15px 60px 15px 60px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    main {
      padding: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      min-height: calc(100vh - 160px);
    }
    .truyen-card {
      width: 200px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      overflow: hidden;
      text-align: center;
      transition: transform .2s, box-shadow .2s;
      cursor: pointer;
    }
    .truyen-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 16px rgba(0,0,0,.25);
    }
    .truyen-card img {
      width: 100%;
      height: 260px;
      object-fit: cover;
      display:block;
    }
    .truyen-card h3 {
      padding: 10px;
      font-size: 16px;
      margin: 0;
    }
    footer {
      background: var(--primary);
      color: white;
      text-align: center;
      padding: 10px;
      margin-top: auto;
    }
    /* Reading page */
    .reading-container {
      width: 100%;
      max-width: 1000px;
      margin: 0 auto;
      padding: 10px;
    }
    .chapter-controls {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }
    .chapter-controls .left,
    .chapter-controls .right {
      display:flex; gap:8px; align-items:center; justify-content:flex-start;
    }
    .chapter-controls .right { justify-content:flex-end; }
    .chapter-controls select, .chapter-controls button, .chapter-controls label {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: white;
      font-size: 15px;
      cursor: pointer;
    }
    .chapter-controls button:hover { background:#f0f0f0; }
    .chapter-title { text-align: center; margin: 6px 0 16px; font-size: 22px; }
    .manga-page { width: 100%; margin: 8px 0; text-align: center; }
    .manga-page img {
      max-width: 100%;
      height: auto;
      border-radius: 6px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      background:#eee;
    }
    .page-controls {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 16px 0 30px;
    }
    .hidden { display:none; }
    .loading { text-align: center; padding: 20px; font-size: 18px; }
    .home-btn {
      position: absolute;
      left: 15px;
      top: 15px;
      padding: 6px 10px;
      background: white;
      color: var(--primary);
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:disabled { opacity: .55; cursor: not-allowed; }
    .error-message { color: #c62828; text-align: center; padding: 20px; }
    .tip { text-align:center; font-size:13px; color:#666; margin-top:8px; }
  </style>
</head>
<body>
  <header>
    <h1>üìñ Web ƒê·ªçc Truy·ªán</h1>
    <button class="home-btn" onclick="goHome()">Trang ch·ªß</button>
  </header>

  <main id="main-content">
    <div id="truyen-list"></div>

    <div id="reading-page" class="hidden">
      <div class="reading-container">
        <div class="chapter-controls">
          <div class="left">
            <button id="prev-chap">Chap tr∆∞·ªõc</button>
            <select id="chap-select"></select>
            <button id="next-chap">Chap sau</button>
          </div>
          <div class="center">
            <span id="page-indicator">Trang 1/1</span>
          </div>
          <div class="right">
            <label><input type="checkbox" id="scroll-mode"> Cu·ªôn d·ªçc</label>
          </div>
        </div>
        <h2 class="chapter-title" id="chapter-title"></h2>
        <div id="manga-pages"></div>
        <div class="page-controls" id="pager">
          <button id="prev-page">Trang tr∆∞·ªõc</button>
          <button id="next-page">Trang sau</button>
        </div>
        <p class="tip">M·∫πo: D√πng ph√≠m &larr; &rarr; ƒë·ªÉ l·∫≠t trang, &uarr; &darr; ƒë·ªÉ cu·ªôn.</p>
      </div>
    </div>
  </main>

  <footer>
    <p>Made with ‚ù§Ô∏è by xFear</p>
  </footer>

  <script>
    // Danh s√°ch truy·ªán
    const truyenList = [
      { ten: "Manhwa1", folder: "Manhwa1", cover: "Manhwa1/bg.jpg", soChap: 97 }
    ];

    // Bi·∫øn to√†n c·ª•c
    let currentTruyen = null;
    let currentChap = 1;
    let currentPage = 1;
    let totalPages = 0;
    let scrollMode = false; // Hi·ªÉn th·ªã t·∫•t c·∫£ trang theo chi·ªÅu d·ªçc

    // Helpers
    const imgPath = (folder, chap, page) => `${folder}/Chap${chap}/${page}.jpg`; // <-- s·ª≠ d·ª•ng "/" chu·∫©n web
    const existCache = new Map(); // cache t·ªìn t·∫°i ·∫£nh

    // Kh·ªüi t·∫°o
    document.addEventListener('DOMContentLoaded', () => {
      renderTruyenList();
      document.getElementById('prev-chap').addEventListener('click', goToPrevChap);
      document.getElementById('next-chap').addEventListener('click', goToNextChap);
      document.getElementById('prev-page').addEventListener('click', goToPrevPage);
      document.getElementById('next-page').addEventListener('click', goToNextPage);
      document.getElementById('chap-select').addEventListener('change', function(){ goToChap(parseInt(this.value)); });
      document.getElementById('scroll-mode').addEventListener('change', function(){
        scrollMode = this.checked;
        renderCurrent();
      });
      // Keyboard
      window.addEventListener('keydown', (e) => {
        if (document.getElementById('reading-page').classList.contains('hidden')) return;
        if (e.key === 'ArrowLeft') goToPrevPage();
        else if (e.key === 'ArrowRight') goToNextPage();
        else if (e.key === 'ArrowUp') window.scrollBy(0, -window.innerHeight * 0.8);
        else if (e.key === 'ArrowDown') window.scrollBy(0, window.innerHeight * 0.8);
      });
    });

    function renderTruyenList(){
      const listEl = document.getElementById('truyen-list');
      listEl.innerHTML = '';
      truyenList.forEach(t => {
        const card = document.createElement('div');
        card.className = 'truyen-card';
        card.innerHTML = `
          <img src="${t.cover}" alt="${t.ten}" onerror="this.src='https://via.placeholder.com/200x260?text=·∫¢nh+b√¨a'">
          <h3>${t.ten}</h3>
          <p>${t.soChap} ch∆∞∆°ng</p>`;
        card.addEventListener('click', () => openTruyen(t));
        listEl.appendChild(card);
      });
    }

    function openTruyen(truyen){
      currentTruyen = truyen; currentChap = 1; currentPage = 1;
      document.getElementById('truyen-list').classList.add('hidden');
      document.getElementById('reading-page').classList.remove('hidden');
      document.querySelector('header h1').textContent = `üìñ ${truyen.ten}`;

      const sel = document.getElementById('chap-select');
      sel.innerHTML = '';
      for (let i=1; i<=truyen.soChap; i++){
        const opt = document.createElement('option');
        opt.value = i; opt.textContent = `Ch∆∞∆°ng ${i}`;
        if (i===currentChap) opt.selected = true;
        sel.appendChild(opt);
      }
      loadChap(currentChap);
    }

    function goHome(){
      document.getElementById('reading-page').classList.add('hidden');
      document.getElementById('truyen-list').classList.remove('hidden');
      document.querySelector('header h1').textContent = 'üìñ Web ƒê·ªçc Truy·ªán';
      currentTruyen = null;
    }

    async function loadChap(chapNumber){
      if (!currentTruyen) return;
      currentChap = chapNumber; currentPage = 1;
      document.getElementById('chap-select').value = chapNumber;
      document.getElementById('chapter-title').textContent = `${currentTruyen.ten} - Ch∆∞∆°ng ${chapNumber}`;

      const mangaPages = document.getElementById('manga-pages');
      mangaPages.innerHTML = '<div class="loading">ƒêang d√≤ trang...</div>';

      totalPages = await detectTotalPages(chapNumber);
      if (totalPages === 0){
        mangaPages.innerHTML = '<div class="error-message">Kh√¥ng t√¨m th·∫•y trang n√†o trong chap n√†y.</div>';
      } else {
        renderCurrent();
      }
      updateControls();
      window.scrollTo(0,0);
    }

    function updateControls(){
      document.getElementById('page-indicator').textContent = totalPages>0 ? `Trang ${currentPage}/${totalPages}` : 'Trang 0/0';
      document.getElementById('prev-page').disabled = (currentPage<=1);
      document.getElementById('next-page').disabled = (currentPage>=totalPages);
      document.getElementById('prev-chap').disabled = (currentChap<=1);
      document.getElementById('next-chap').disabled = (currentChap>=currentTruyen.soChap);
      document.getElementById('pager').classList.toggle('hidden', scrollMode);
    }

    async function detectTotalPages(chapNumber){
      // Ki·ªÉm tra ·∫£nh 1.jpg ƒë·ªÉ bi·∫øt chap t·ªìn t·∫°i
      const firstPath = imgPath(currentTruyen.folder, chapNumber, 1);
      const ok = await checkImage(firstPath);
      if (!ok) return 0;
      // ƒê·∫øm ƒë·∫øn khi g·∫∑p ·∫£nh kh√¥ng t·ªìn t·∫°i
      let page=1;
      while (await checkImage(imgPath(currentTruyen.folder, chapNumber, page+1))) page++;
      return page;
    }

    function checkImage(src){
      const cached = existCache.get(src);
      if (cached !== undefined) return Promise.resolve(cached);
      return new Promise(resolve => {
        const im = new Image();
        im.onload = () => { existCache.set(src, true); resolve(true); };
        im.onerror = () => { existCache.set(src, false); resolve(false); };
        im.src = src;
      });
    }

    function renderCurrent(){
      if (scrollMode) renderAllPages(); else loadPage(currentPage);
      updateControls();
    }

    function renderAllPages(){
      const wrap = document.getElementById('manga-pages');
      wrap.innerHTML = '';
      for (let p=1; p<=totalPages; p++){
        const div = document.createElement('div');
        div.className = 'manga-page';
        const img = document.createElement('img');
        img.src = imgPath(currentTruyen.folder, currentChap, p);
        img.alt = `Trang ${p}`;
        img.loading = 'lazy';
        img.onerror = function(){ this.src='https://via.placeholder.com/800x1200?text=Kh√¥ng+t√¨m+th·∫•y+trang'; };
        div.appendChild(img);
        wrap.appendChild(div);
      }
    }

    function preloadNext(pageNumber){
      const next = pageNumber + 1;
      if (next <= totalPages){
        const im = new Image();
        im.src = imgPath(currentTruyen.folder, currentChap, next);
      }
    }

    function loadPage(pageNumber){
      if (!currentTruyen || pageNumber<1 || pageNumber>totalPages) return;
      currentPage = pageNumber;
      const wrap = document.getElementById('manga-pages');
      wrap.innerHTML = '';
      const div = document.createElement('div');
      div.className = 'manga-page';
      const img = document.createElement('img');
      img.src = imgPath(currentTruyen.folder, currentChap, pageNumber);
      img.alt = `Trang ${pageNumber}`;
      img.onerror = function(){ this.src='https://via.placeholder.com/800x1200?text=Kh√¥ng+t√¨m+th·∫•y+trang'; };
      div.appendChild(img);
      wrap.appendChild(div);
      window.scrollTo({top:0, behavior:'instant'});
      updateControls();
      preloadNext(pageNumber);
    }

    function goToPrevChap(){ if (currentChap>1) loadChap(currentChap-1); }
    function goToNextChap(){ if (currentTruyen && currentChap<currentTruyen.soChap) loadChap(currentChap+1); }
    function goToChap(n){ if (n>=1 && n<=currentTruyen.soChap) loadChap(n); }

    function goToPrevPage(){
      if (scrollMode){ window.scrollBy(0, -window.innerHeight*0.8); return; }
      if (currentPage>1) loadPage(currentPage-1);
      else if (currentChap>1){
        const prev = currentChap-1;
        loadChap(prev);
        // ƒë·ª£i detect xong r·ªìi nh·∫£y trang cu·ªëi
        const intv = setInterval(() => {
          if (totalPages>0){ loadPage(totalPages); clearInterval(intv); }
        }, 120);
      }
    }
    function goToNextPage(){
      if (scrollMode){ window.scrollBy(0, window.innerHeight*0.8); return; }
      if (currentPage<totalPages) loadPage(currentPage+1);
      else if (currentTruyen && currentChap<currentTruyen.soChap) goToNextChap();
    }
  </script>
</body>
</html>
