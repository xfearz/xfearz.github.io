<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Trang ƒê·ªçc Truy·ªán ‚Äì t·ªëi ∆∞u m·∫°ng y·∫øu + l∆∞u ti·∫øn ƒë·ªô + ƒëƒÉng nh·∫≠p</title>
<style>
:root { --primary:#2d89ef; --bg:#f7f7f7; --text:#222; }
*{box-sizing:border-box} body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
header{position:sticky;top:0;z-index:10;background:var(--primary);color:#fff;padding:12px 56px;text-align:center}
.home-btn{position:absolute;left:12px;top:12px;border:none;border-radius:6px;padding:6px 10px;background:#fff;color:var(--primary);cursor:pointer}
.truyen-card{width:200px;background:#fff;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.2);overflow:hidden;cursor:pointer;transition:.2s;position:relative}
.truyen-card:hover{transform:translateY(-3px);box-shadow:0 6px 14px rgba(0,0,0,.25)}
.truyen-card img{width:100%;height:260px;object-fit:cover;display:block}
.truyen-card h3{margin:0;padding:10px;font-size:16px}

/* ====== Layout switch (D·ªçc / Ngang) ====== */
#home-bar.layout-switch{max-width:1100px;width:100%;margin:8px auto 6px;display:flex;gap:8px;justify-content:flex-end}
.layout-btn{padding:8px 12px;border:1px solid #ddd;background:#fff;border-radius:8px;cursor:pointer}
.layout-btn.active{background:var(--primary);color:#fff;border-color:transparent}

/* D·ªçc (Grid) */
#truyen-list.grid{
  max-width:1100px;margin:0 auto;
  display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;
}

/* Ngang (Row / Carousel) */
#truyen-list.row{
  max-width:1100px;margin:0 auto;
  display:flex;gap:12px;overflow-x:auto;padding:8px 6px;
  scroll-snap-type:x mandatory;
}
#truyen-list.row::-webkit-scrollbar{height:8px}
#truyen-list.row::-webkit-scrollbar-thumb{background:#ccc;border-radius:999px}
#truyen-list.row .truyen-card{flex:0 0 200px;scroll-snap-align:start}

.reading-container{max-width:1000px;margin:0 auto;width:100%}
.chapter-controls{position:sticky;top:56px;z-index:9;background:#fff;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.08);padding:8px 10px;margin-bottom:10px;display:flex;gap:8px;align-items:center;justify-content:space-between}
.chapter-controls select,.chapter-controls button{padding:8px 12px;border:1px solid #ddd;border-radius:6px;background:#fff;cursor:pointer}
.chapter-controls button[disabled]{opacity:.5;cursor:not-allowed}
.chapter-title{text-align:center;margin:8px 0 12px;font-size:20px}
#manga-pages{display:flex;flex-direction:column;gap:8px}
.page{width:100%;text-align:center}
.page picture,img{max-width:100%;height:auto;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.18);background:#eee;content-visibility:auto}
.skel{width:100%;height:320px;border-radius:6px;background:linear-gradient(90deg,#eee,#f5f5f5,#eee);background-size:200% 100%;animation:sh 1.2s linear infinite}
@keyframes sh{0%{background-position:0 0}100%{background-position:-200% 0}}
.badge{font-size:12px;padding:4px 8px;border-radius:999px;background:#eef;color:#234}
.tip{font-size:13px;color:#666;text-align:center;margin:8px 0 16px}
.floater{position:fixed;right:14px;bottom:14px;display:flex;flex-direction:column;gap:10px;z-index:20}
.float-btn{border:none;border-radius:999px;padding:10px 14px;background:#fff;color:var(--primary);box-shadow:0 4px 12px rgba(0,0,0,.2);cursor:pointer;font-weight:600}
.hidden{display:none}

/* LOGIN OVERLAY */
#login-overlay{position:fixed;inset:0;z-index:9999;background:linear-gradient(180deg,rgba(0,0,0,.6),rgba(0,0,0,.7));display:flex;align-items:center;justify-content:center}
.login-card{width:min(92vw,380px);background:#fff;border-radius:14px;padding:22px;box-shadow:0 10px 30px rgba(0,0,0,.35);text-align:center}
.login-card h2{margin:6px 0 4px}.login-card p{margin:6px 0 16px;color:#444;font-size:14px}
.login-input{width:100%;padding:12px 14px;font-size:16px;border:1px solid #ddd;border-radius:10px;outline:none}
.login-actions{margin-top:14px;display:flex;gap:10px;justify-content:center}
.login-btn{padding:10px 14px;border:none;border-radius:10px;cursor:pointer;font-weight:700}
.btn-primary{background:var(--primary);color:#fff}.btn-ghost{background:#f4f6ff;color:#345}
.login-note{font-size:12px;color:#666;margin-top:10px}

/* END CONTROL (n√∫t qua chap sau ·ªü cu·ªëi trang) */
.end-controls{display:flex;justify-content:center;margin:18px 0 28px}
.end-controls .next-chap-btn{padding:10px 16px;border:none;border-radius:999px;font-weight:700;background:var(--primary);color:#fff;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,.2)}
</style>
</head>
<body>
<header>
  <h1>üìñ Web ƒê·ªçc Truy·ªán</h1>
  <button class="home-btn" onclick="goHome()">Trang ch·ªß</button>
</header>

<!-- LOGIN OVERLAY -->
<div id="login-overlay" aria-hidden="true">
  <div class="login-card" role="dialog" aria-modal="true" aria-labelledby="login-title">
    <h2 id="login-title">ƒêƒÉng nh·∫≠p</h2>
    <p>Nh·∫≠p <b>m·∫≠t kh·∫©u</b> ƒë·ªÉ v√†o xem.</p>
    <input id="login-input" class="login-input" type="password" autocomplete="off" placeholder="M·∫≠t kh·∫©u" />
    <div class="login-actions">
      <button id="login-submit" class="login-btn btn-primary">V√†o</button>
      <button id="login-youtube" class="login-btn btn-ghost">Tho√°t</button>
    </div>
    <div class="login-note">ƒêƒÉng nh·∫≠p s·∫Ω ƒë∆∞·ª£c l∆∞u b·∫±ng cookie cho ƒë·∫øn khi b·∫°n x√≥a cookie.</div>
  </div>
</div>

<main>
  <!-- Thanh ƒë·ªïi layout (ch·ªâ hi·ªán ·ªü Trang ch·ªß) -->
  <div id="home-bar" class="layout-switch">
    <button id="layout-grid" class="layout-btn active" title="Hi·ªÉn th·ªã d·ªçc (l∆∞·ªõi)">D·ªçc</button>
    <button id="layout-row" class="layout-btn" title="Hi·ªÉn th·ªã ngang (cu·ªôn)">Ngang</button>
  </div>

  <div id="truyen-list"></div>

  <div id="reading-page" class="hidden">
    <div class="reading-container">
      <div class="chapter-controls" id="chapter-top">
        <div style="display:flex;gap:8px;align-items:center">
          <button id="prev-chap">Chap tr∆∞·ªõc</button>
          <select id="chap-select"></select>
          <button id="next-chap">Chap sau</button>
        </div>
        <div><span id="page-indicator" class="badge">Trang 0</span></div>
        <div style="display:flex;gap:8px;align-items:center">
          <label style="font-size:13px;opacity:.8">Ch·∫ø ƒë·ªô ti·∫øt ki·ªám</label>
          <input type="checkbox" id="data-saver" checked />
        </div>
      </div>

      <h2 class="chapter-title" id="chapter-title"></h2>
      <div id="manga-pages"></div>
      <div class="end-controls"><button id="next-chap-bottom" class="next-chap-btn">‚è≠ Qua chap sau</button></div>
      <p class="tip">Cu·ªôn d·ªçc, ·∫£nh t·∫£i l·∫ßn l∆∞·ª£t. B·∫≠t ‚ÄúCh·∫ø ƒë·ªô ti·∫øt ki·ªám‚Äù ƒë·ªÉ gi·ªõi h·∫°n k·∫øt n·ªëi khi m·∫°ng y·∫øu.</p>
    </div>
  </div>
</main>

<div id="floater" class="floater hidden">
  <button class="float-btn" id="to-top">‚§¥ L√™n ƒë·∫ßu chap</button>
  <button class="float-btn" id="to-bottom">‚§µ Xu·ªëng cu·ªëi chap</button>
</div>

<script>
/* ===== Helpers & constants ===== */
const $ = id => document.getElementById(id);
function setCookie(n,v,d=365){const t=new Date();t.setTime(t.getTime()+d*24*60*60*1000);document.cookie=`${n}=${encodeURIComponent(v)}; expires=${t.toUTCString()}; path=/; SameSite=Lax`}
function getCookie(n){const m=document.cookie.match(new RegExp('(?:^|; )'+n+'=([^;]*)'));return m?decodeURIComponent(m[1]):null}
const throttle=(fn,ms)=>{let t=0;return(...a)=>{const n=Date.now();if(n-t>=ms){t=n;fn(...a)}}};
const BASE=(()=>{const p=location.pathname;return p.endsWith('/')?p:p.replace(/[^/]+$/,'');})();
const SAVE_KEY='manga_reader_progress_v1';
const LAYOUT_KEY='manga_home_layout_v1';
const PASSWORD='MANHWA';

/* ===== Data ===== */
const truyenList=[
  { ten:"Manhwa1", folder:"Manhwa1", cover:"Manhwa1/bg.jpg", soChap:97 },
  { ten:"Manhwa2", folder:"Manhwa2", cover:"Manhwa2/bg.jpg", soChap:2  },
  { ten:"Manhwa3", folder:"Manhwa3", cover:"Manhwa3/bg.jpg", soChap:18 },
  { ten:"Manhwa4", folder:"Manhwa4", cover:"Manhwa4/bg.jpg", soChap:33 }
];

/* ===== App State ===== */
let __appInitialized=false;
let currentTruyen=null, currentChap=1;
let endReached=false, nextToDiscover=1, discoveredCount=0, inFlight=0;
let MAX_CONCURRENCY=2;
const DISCOVER_AHEAD=4;
const patternCache=new Map();   // key = `${folder}-${chap}`
const existCache=new Map();

/* ===== UI toggles ===== */
function enterReaderUI(){
  $('truyen-list').classList.add('hidden');
  $('home-bar').classList.add('hidden');
  $('reading-page').classList.remove('hidden');
}
function enterHomeUI(){
  $('reading-page').classList.add('hidden');
  $('truyen-list').classList.remove('hidden');
  $('home-bar').classList.remove('hidden');
  document.querySelector('header h1').textContent='üìñ Web ƒê·ªçc Truy·ªán';
  currentTruyen=null;
}

/* ===== Layout apply ===== */
function applyLayout(mode){
  const list=$('truyen-list');
  const bG=$('layout-grid'), bR=$('layout-row');
  if(mode!=='row') mode='grid';
  list.classList.toggle('grid',mode==='grid');
  list.classList.toggle('row',mode==='row');
  bG.classList.toggle('active',mode==='grid');
  bR.classList.toggle('active',mode==='row');
  try{ localStorage.setItem(LAYOUT_KEY,mode); }catch(_){}
}

/* ===== URL helpers ===== */
function updateReadingURL(){
  const url=new URL(location.href);
  url.search=`?truyen=${encodeURIComponent(currentTruyen.folder)}&chap=${currentChap}`;
  history.replaceState({},'',url);
}
function goHomeURL(){
  const url=new URL(location.href); url.search=''; history.replaceState({},'',url);
}

/* ===== Login ===== */
function showLogin(){ $('login-overlay').style.display='flex'; document.body.style.overflow='hidden'; setTimeout(()=>$('login-input')?.focus(),50); }
function hideLoginAndRemove(){ const o=$('login-overlay'); if(o) o.parentNode.removeChild(o); document.body.style.overflow=''; }
function handleLoginSubmit(){ const v=($('login-input')?.value||'').trim(); if(v===PASSWORD){ setCookie('manga_login','1',365); hideLoginAndRemove(); afterLoginInit(); } else location.href='https://www.youtube.com/'; }

document.addEventListener('DOMContentLoaded',()=>{
  $('login-submit').addEventListener('click',handleLoginSubmit);
  $('login-input').addEventListener('keydown',e=>{ if(e.key==='Enter') handleLoginSubmit(); });
  $('login-youtube').addEventListener('click',()=>location.href='https://youtu.be/dQw4w9WgXcQ?si=YDqO3eEabYEtae90');
  if(getCookie('manga_login')==='1'){ hideLoginAndRemove(); afterLoginInit(); } else showLogin();
});

/* ===== Reader utils ===== */
const pageUrl=(folder,chap,page,pat)=>(
  pat==='backslash' ? `${BASE}${folder}/Chap${chap}/Chap${chap}%5C${page}.jpg`
                    : `${BASE}${folder}/Chap${chap}/${page}.jpg`
);

function probe(src,{timeoutMs=10000,retries=1}={}){
  const c=existCache.get(src); if(c!==undefined) return Promise.resolve(c);
  return new Promise(resolve=>{
    let done=false,tmr;
    const img=new Image();
    const finish=ok=>{ if(done) return; done=true; clearTimeout(tmr); existCache.set(src,ok); resolve(ok); };
    img.onload=()=>finish(true);
    img.onerror=async()=>{ if(retries>0){ await new Promise(r=>setTimeout(r,600)); resolve(probe(src,{timeoutMs,retries:retries-1})); } else finish(false); };
    tmr=setTimeout(()=>finish(false),timeoutMs);
    img.src=src;
  });
}

async function detectPattern(folder,chap){
  const key=`${folder}-${chap}`;
  if(patternCache.has(key)) return patternCache.get(key);
  const a=pageUrl(folder,chap,1,'plain');
  const b=pageUrl(folder,chap,1,'backslash');
  const okA=await probe(a,{retries:1});
  const pat= okA ? 'plain' : (await probe(b,{retries:1}) ? 'backslash' : null);
  if(!pat) return null;
  patternCache.set(key,pat);
  return pat;
}

/* ===== Save/restore progress ===== */
function saveProgress(state){ try{ localStorage.setItem(SAVE_KEY, JSON.stringify({...state,ts:Date.now()})); }catch(_){ } }
function loadProgress(){ try{ const raw=localStorage.getItem(SAVE_KEY); if(!raw) return null; const d=JSON.parse(raw); if(!d||!d.truyen||!d.chap) return null; return d; }catch(_){ return null; } }
function clearProgress(){ try{ localStorage.removeItem(SAVE_KEY);}catch(_){ } }
function getVisiblePageApprox(){
  const pages=[...document.querySelectorAll('#manga-pages .page')];
  const top=window.scrollY+72; let best=1,bd=1e9;
  for(const el of pages){ const y=el.getBoundingClientRect().top+window.scrollY; const d=Math.abs(y-top); if(d<bd){bd=d; best=+(el.dataset.page||1);} }
  return best;
}
const throttledSave=throttle(()=>{ if(currentTruyen){ const p=getVisiblePageApprox(); saveProgress({truyen:currentTruyen.ten, chap:currentChap, page:p}); } },1000);

/* ===== After login ===== */
function afterLoginInit(){
  if(__appInitialized) return; __appInitialized=true;

  renderList();
  enterHomeUI(); // m·∫∑c ƒë·ªãnh l√† trang ch·ªß

  const savedLayout=localStorage.getItem(LAYOUT_KEY)||'grid';
  applyLayout(savedLayout);
  $('layout-grid').addEventListener('click',()=>applyLayout('grid'));
  $('layout-row').addEventListener('click',()=>applyLayout('row'));

  // Reader controls
  $('prev-chap').addEventListener('click',()=>goToChap(currentChap-1));
  $('next-chap').addEventListener('click',()=>goToChap(currentChap+1));
  $('next-chap-bottom').addEventListener('click',()=>goToChap(currentChap+1));
  $('chap-select').addEventListener('change',e=>goToChap(parseInt(e.target.value,10)));
  $('data-saver').addEventListener('change',()=>{ MAX_CONCURRENCY = $('data-saver').checked ? 2 : 4; });

  $('to-top').addEventListener('click',()=>$('chapter-top').scrollIntoView({behavior:'smooth'}));
  $('to-bottom').addEventListener('click',()=>window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'}));
  window.addEventListener('scroll',()=>{
    $('floater').classList.toggle('hidden', window.scrollY<400 || $('reading-page').classList.contains('hidden'));
    throttledSave();
  });

  // N·∫øu URL c√≥ query => m·ªü tr·ª±c ti·∫øp
  const params=new URLSearchParams(location.search);
  if(params.has('truyen')){
    const key=params.get('truyen');
    const chap=parseInt(params.get('chap')||'1',10)||1;
    const tr=truyenList.find(x=>x.folder===key||x.ten===key);
    if(tr){ openTruyen(tr,{restore:{chap,page:1}}); return; }
  }

  // Ho·∫∑c ph·ª•c h·ªìi ti·∫øn ƒë·ªô
  const st=loadProgress();
  if(st){
    const tr=truyenList.find(x=>x.ten===st.truyen||x.folder===st.truyen);
    if(tr){ openTruyen(tr,{restore:st}); return; }
  }
}

/* ===== Home list ===== */
function renderList(){
  const list=$('truyen-list'); list.innerHTML='';
  truyenList.forEach(t=>{
    const c=document.createElement('div'); c.className='truyen-card';
    c.innerHTML=`
      <img src="${BASE}${t.cover}" alt="${t.ten}" onerror="this.src='https://via.placeholder.com/200x260?text=·∫¢nh+b√¨a'">
      <h3>${t.ten}</h3>
      <p style="padding:0 10px 12px;opacity:.7">${t.soChap} ch∆∞∆°ng</p>
    `;
    c.addEventListener('click',()=>{
      // m·ªü trang ƒë·ªçc v√† c·∫≠p nh·∫≠t URL (kh√¥ng reload)
      openTruyen(t);
    });
    list.appendChild(c);
  });
}

/* ===== Navigation ===== */
function goHome(){
  clearProgress(); // tu·ª≥ b·∫°n: xo√° ƒë·ªÉ kh√¥ng t·ª± nh·∫£y v√†o ch·ªó d·ªü
  enterHomeUI();
  goHomeURL();
}

function updateChapButtons(){
  const prev=$('prev-chap'), next=$('next-chap'), nextBottom=$('next-chap-bottom');
  const atFirst = currentChap<=1;
  const atLast  = currentTruyen ? currentChap>=currentTruyen.soChap : true;
  prev.disabled = atFirst;
  next.disabled = atLast;
  nextBottom.disabled = atLast;
  // c·∫≠p nh·∫≠t select hi·ªÉn th·ªã
  $('chap-select').value = String(currentChap);
}

/* ===== Open & read chapter ===== */
function openTruyen(t,opts={}){
  currentTruyen=t; currentChap=1;
  enterReaderUI();
  document.querySelector('header h1').textContent=`üìñ ${t.ten}`;

  const sel=$('chap-select'); sel.innerHTML='';
  for(let i=1;i<=t.soChap;i++){ const o=document.createElement('option'); o.value=i; o.textContent=`Ch∆∞∆°ng ${i}`; sel.appendChild(o); }

  if(opts.restore && Number.isFinite(opts.restore.chap)){
    startChapter(opts.restore.chap, {restorePage: opts.restore.page||1});
  }else{
    startChapter(1);
  }
  updateReadingURL();
}

function goToChap(n){
  if(!currentTruyen) return;
  if(n<1 || n>currentTruyen.soChap) return;
  startChapter(n);
}

/* ===== Core reading (lazy) ===== */
async function startChapter(ch,opts={}){
  if(!currentTruyen) return;
  currentChap=ch;
  updateChapButtons();
  $('chapter-title').textContent=`${currentTruyen.ten} - Ch∆∞∆°ng ${ch}`;
  $('manga-pages').innerHTML='';
  $('page-indicator').textContent='Trang 0';
  endReached=false; nextToDiscover=1; discoveredCount=0; inFlight=0;

  updateReadingURL();

  const pat=await detectPattern(currentTruyen.folder,ch);
  if(!pat){
    $('manga-pages').innerHTML=`<div class="page"><div class="skel"></div><p style="color:#c33">Kh√¥ng t√¨m th·∫•y trang 1 c·ªßa chap.</p></div>`;
    return;
  }

  for(let i=0;i<DISCOVER_AHEAD;i++) spawnNextPlaceholder(pat);

  let sentinel=$('sentinel');
  if(!sentinel){ sentinel=document.createElement('div'); sentinel.id='sentinel'; sentinel.style.height='1px'; $('manga-pages').appendChild(sentinel); }
  const ioMore=new IntersectionObserver((entries)=>{
    if(entries.some(e=>e.isIntersecting)){ for(let i=0;i<2;i++) spawnNextPlaceholder(pat); }
  },{rootMargin:'1200px 0px'});
  ioMore.observe(sentinel);

  if(opts.restorePage && Number.isFinite(opts.restorePage)){
    await ensurePageExists(pat, opts.restorePage);
    scrollToPage(opts.restorePage);
    saveProgress({truyen:currentTruyen.ten, chap:currentChap, page:opts.restorePage});
  }else{
    window.scrollTo({top:0,behavior:'instant'});
  }
}

function spawnNextPlaceholder(pat){
  if(endReached) return;
  const p=nextToDiscover++;
  const holder=document.createElement('div'); holder.className='page'; holder.dataset.page=String(p);
  holder.appendChild(Object.assign(document.createElement('div'),{className:'skel'}));
  const sent=$('sentinel');
  $('manga-pages').insertBefore(holder, sent||null);
  lazyLoad(holder, pat);
}

function lazyLoad(holder, pat){
  const io=new IntersectionObserver(async (entries,obs)=>{
    if(!entries[0].isIntersecting) return;
    obs.unobserve(holder);
    await loadOne(holder, pat);
  },{rootMargin:'600px 0px'});
  io.observe(holder);
}

async function loadOne(holder, pat){
  if(endReached || inFlight>=MAX_CONCURRENCY){ setTimeout(()=>loadOne(holder,pat),160); return; }
  const page=parseInt(holder.dataset.page,10);
  const src=pageUrl(currentTruyen.folder,currentChap,page,pat);

  inFlight++;
  const ok=await probe(src,{timeoutMs:12000,retries:2});
  inFlight--;

  if(!ok){
    if(page===1) holder.innerHTML=`<p style="color:#c33">Kh√¥ng t·∫£i ƒë∆∞·ª£c trang 1.</p>`;
    endReached=true; return;
  }

  const img=new Image();
  img.loading='lazy'; img.decoding='async'; img.fetchPriority= discoveredCount<2 ? 'high':'low';
  img.alt=`Trang ${page}`; img.src=src;
  img.onerror=()=>{ img.replaceWith(document.createTextNode('L·ªói t·∫£i ·∫£nh.')); };

  holder.innerHTML=''; holder.appendChild(img);
  discoveredCount++; $('page-indicator').textContent=`Trang ${discoveredCount}`;
}

/* Helpers cho scroll/ensure */
function scrollToPage(p){
  const el=document.querySelector(`#manga-pages .page[data-page="${p}"]`);
  if(el){ const y=el.getBoundingClientRect().top+window.scrollY-70; window.scrollTo({top:y,behavior:'instant'}); }
}
async function ensurePageExists(pat,targetPage,maxWaitMs=8000){
  const start=Date.now();
  while(!document.querySelector(`#manga-pages .page[data-page="${targetPage}"]`)){
    if(endReached) break;
    spawnNextPlaceholder(pat);
    if(Date.now()-start>maxWaitMs) break;
    await new Promise(r=>setTimeout(r,120));
  }
}
</script>
</body>
</html>