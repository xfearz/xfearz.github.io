<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Trang ƒê·ªçc Truy·ªán ‚Äì t·ªëi ∆∞u m·∫°ng y·∫øu + l∆∞u ti·∫øn ƒë·ªô + ƒëƒÉng nh·∫≠p</title>
<style>
:root { --primary:#2d89ef; --bg:#f7f7f7; --text:#222; }
*{box-sizing:border-box} body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
header{position:sticky;top:0;z-index:10;background:var(--primary);color:#fff;padding:12px 56px;text-align:center}
.home-btn{position:absolute;left:12px;top:12px;border:none;border-radius:6px;padding:6px 10px;background:#fff;color:var(--primary);cursor:pointer}
main{padding:14px;display:flex;flex-wrap:wrap;gap:16px;justify-content:center;min-height:60vh}
.truyen-card{width:200px;background:#fff;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.2);overflow:hidden;cursor:pointer;transition:.2s}
.truyen-card:hover{transform:translateY(-3px);box-shadow:0 6px 14px rgba(0,0,0,.25)}
.truyen-card img{width:100%;height:260px;object-fit:cover;display:block}
.truyen-card h3{margin:0;padding:10px;font-size:16px}

.reading-container{max-width:1000px;margin:0 auto;width:100%}
.chapter-controls{position:sticky;top:56px;z-index:9;background:#fff;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.08);padding:8px 10px;margin-bottom:10px;display:flex;gap:8px;align-items:center;justify-content:space-between}
.chapter-controls select,.chapter-controls button{padding:8px 12px;border:1px solid #ddd;border-radius:6px;background:#fff;cursor:pointer}
.chapter-title{text-align:center;margin:8px 0 12px;font-size:20px}
#manga-pages{display:flex;flex-direction:column;gap:8px}
.page{width:100%;text-align:center}
.page picture,img{max-width:100%;height:auto;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.18);background:#eee;content-visibility:auto}
.skel{width:100%;height:320px;border-radius:6px;background:linear-gradient(90deg,#eee,#f5f5f5,#eee);background-size:200% 100%;animation:sh 1.2s linear infinite}
@keyframes sh{0%{background-position:0 0}100%{background-position:-200% 0}}
.badge{font-size:12px;padding:4px 8px;border-radius:999px;background:#eef;color:#234}
.tip{font-size:13px;color:#666;text-align:center;margin:8px 0 16px}
.floater{position:fixed;right:14px;bottom:14px;display:flex;flex-direction:column;gap:10px;z-index:20}
.float-btn{border:none;border-radius:999px;padding:10px 14px;background:#fff;color:var(--primary);box-shadow:0 4px 12px rgba(0,0,0,.2);cursor:pointer;font-weight:600}
.hidden{display:none}

/* LOGIN OVERLAY */
#login-overlay{position:fixed;inset:0;z-index:9999;background:linear-gradient(180deg,rgba(0,0,0,.6),rgba(0,0,0,.7));display:flex;align-items:center;justify-content:center}
.login-card{width:min(92vw,380px);background:#fff;border-radius:14px;padding:22px;box-shadow:0 10px 30px rgba(0,0,0,.35);text-align:center}
.login-card h2{margin:6px 0 4px}.login-card p{margin:6px 0 16px;color:#444;font-size:14px}
.login-input{width:100%;padding:12px 14px;font-size:16px;border:1px solid #ddd;border-radius:10px;outline:none}
.login-actions{margin-top:14px;display:flex;gap:10px;justify-content:center}
.login-btn{padding:10px 14px;border:none;border-radius:10px;cursor:pointer;font-weight:700}
.btn-primary{background:var(--primary);color:#fff}.btn-ghost{background:#f4f6ff;color:#345}
.login-note{font-size:12px;color:#666;margin-top:10px}

/* END CONTROL (n√∫t qua chap sau ·ªü cu·ªëi trang) */
.end-controls{display:flex;justify-content:center;margin:18px 0 28px}
.end-controls .next-chap-btn{padding:10px 16px;border:none;border-radius:999px;font-weight:700;background:var(--primary);color:#fff;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,.2)}
</style>
</head>
<body>
<header>
  <h1>üìñ Web ƒê·ªçc Truy·ªán</h1>
  <button class="home-btn" onclick="goHome()">Trang ch·ªß</button>
</header>

<!-- LOGIN OVERLAY (hi·ªán m·∫∑c ƒë·ªãnh n·∫øu ch∆∞a c√≥ cookie) -->
<div id="login-overlay" aria-hidden="true">
  <div class="login-card" role="dialog" aria-modal="true" aria-labelledby="login-title">
    <h2 id="login-title">ƒêƒÉng nh·∫≠p</h2>
    <p>Nh·∫≠p <b>m·∫≠t kh·∫©u</b> ƒë·ªÉ v√†o xem.</p>
    <input id="login-input" class="login-input" type="password" autocomplete="off" placeholder="M·∫≠t kh·∫©u" />
    <div class="login-actions">
      <button id="login-submit" class="login-btn btn-primary">V√†o</button>
      <button id="login-youtube" class="login-btn btn-ghost">Tho√°t</button>
    </div>
    <div class="login-note">ƒêƒÉng nh·∫≠p s·∫Ω ƒë∆∞·ª£c l∆∞u b·∫±ng cookie cho ƒë·∫øn khi b·∫°n x√≥a cookie.</div>
  </div>
</div>

<main>
  <div id="truyen-list"></div>

  <div id="reading-page" class="hidden">
    <div class="reading-container">
      <div class="chapter-controls" id="chapter-top">
        <div style="display:flex;gap:8px;align-items:center">
          <button id="prev-chap">Chap tr∆∞·ªõc</button>
          <select id="chap-select"></select>
          <button id="next-chap">Chap sau</button>
        </div>
        <div><span id="page-indicator" class="badge">Trang 0</span></div>
        <div style="display:flex;gap:8px;align-items:center">
          <label style="font-size:13px;opacity:.8">Ch·∫ø ƒë·ªô ti·∫øt ki·ªám</label>
          <input type="checkbox" id="data-saver" checked />
        </div>
      </div>

      <h2 class="chapter-title" id="chapter-title"></h2>
      <div id="manga-pages"></div>

      <!-- N√∫t qua chap sau ·ªü CU·ªêI TRANG -->
      <div class="end-controls">
        <button id="next-chap-bottom" class="next-chap-btn">‚è≠ Qua chap sau</button>
      </div>

      <p class="tip">Cu·ªôn d·ªçc, ·∫£nh t·∫£i l·∫ßn l∆∞·ª£t. B·∫≠t ‚ÄúCh·∫ø ƒë·ªô ti·∫øt ki·ªám‚Äù ƒë·ªÉ gi·ªõi h·∫°n k·∫øt n·ªëi khi m·∫°ng y·∫øu. (Ti·∫øn ƒë·ªô ƒë·ªçc s·∫Ω ƒë∆∞·ª£c l∆∞u t·ª± ƒë·ªông)</p>
    </div>
  </div>
</main>

<div id="floater" class="floater hidden">
  <button class="float-btn" id="to-top">‚§¥ L√™n ƒë·∫ßu chap</button>
  <button class="float-btn" id="to-bottom">‚§µ Xu·ªëng cu·ªëi chap</button>
</div>

<script>
/* ===== Cookie helpers ===== */
function setCookie(name, value, days=365){
  const d = new Date(); d.setTime(d.getTime()+days*24*60*60*1000);
  document.cookie = `${name}=${encodeURIComponent(value)}; expires=${d.toUTCString()}; path=/; SameSite=Lax`;
}
function getCookie(name){
  const match = document.cookie.match(new RegExp('(?:^|; )'+name+'=([^;]*)'));
  return match ? decodeURIComponent(match[1]) : null;
}

/* ===== Base path (GitHub Pages) ===== */
const BASE = (() => {
  const p = location.pathname;
  return p.endsWith('/') ? p : p.replace(/[^/]+$/, '');
})();

/* ===== Config truy·ªán (v√≠ d·ª•) ===== */
const truyenList = [
  { ten: "Manhwa1", folder: "Manhwa1", cover: "Manhwa1/bg.jpg", soChap: 97 },
  { ten: "Manhwa2", folder: "Manhwa2", cover: "Manhwa2/bg.jpg", soChap: 2 },
  { ten: "Manhwa3", folder: "Manhwa3", cover: "Manhwa3/bg.jpg", soChap: 18 }
];

/* ===== Login config ===== */
const PASSWORD = "MANHWA"; // <<< ƒê·ªîI M·∫¨T KH·∫®U ·ªû ƒê√ÇY
let __appInitialized = false;      // ch·∫∑n init UI nhi·ªÅu l·∫ßn

/* ===== State & tuning ===== */
let currentTruyen = null, currentChap = 1;
let endReached = false, nextToDiscover = 1, discoveredCount = 0;
let inFlight = 0, MAX_CONCURRENCY = 2;
const DISCOVER_AHEAD = 4;
const patternCache = new Map(); // chap -> 'plain' | 'backslash'
const existCache = new Map();

/* ===== Helpers ===== */
const $ = (id) => document.getElementById(id);
const SAVE_KEY = 'manga_reader_progress_v1';

const pageUrl = (folder, chap, page, pat) => (
  pat === 'backslash'
   ? `${BASE}${folder}/Chap${chap}/Chap${chap}%5C${page}.jpg`
   : `${BASE}${folder}/Chap${chap}/${page}.jpg`
);

function probe(src, {timeoutMs=10000, retries=1} = {}) {
  const cached = existCache.get(src);
  if (cached !== undefined) return Promise.resolve(cached);
  return new Promise((resolve) => {
    let done = false, tmr;
    const img = new Image();
    const clean = (ok) => { if (done) return; done = true; clearTimeout(tmr); existCache.set(src, ok); resolve(ok); };
    img.onload = () => clean(true);
    img.onerror = async () => {
      if (retries > 0) { await new Promise(r => setTimeout(r, 600)); resolve(probe(src, {timeoutMs, retries: retries - 1})); }
      else clean(false);
    };
    tmr = setTimeout(() => clean(false), timeoutMs);
    img.src = src;
  });
}

async function detectPattern(folder, chap) {
  if (patternCache.has(chap)) return patternCache.get(chap);
  const plain = pageUrl(folder, chap, 1, 'plain');
  const back  = pageUrl(folder, chap, 1, 'backslash');
  const okPlain = await probe(plain, {retries:1});
  const pat = okPlain ? 'plain' : (await probe(back, {retries:1}) ? 'backslash' : null);
  if (!pat) return null;
  patternCache.set(chap, pat);
  return pat;
}

/* ====== L∆∞u/Ph·ª•c h·ªìi ti·∫øn ƒë·ªô ====== */
function saveProgress(state){
  try { localStorage.setItem(SAVE_KEY, JSON.stringify({...state, ts: Date.now()})); } catch(_) {}
}
function loadProgress(){
  try {
    const raw = localStorage.getItem(SAVE_KEY);
    if (!raw) return null;
    const data = JSON.parse(raw);
    if (!data || !data.truyen || !data.chap) return null;
    return data;
  } catch(_) { return null; }
}
function clearProgress(){
  try { localStorage.removeItem(SAVE_KEY); } catch(_) {}
}
function getVisiblePageApprox(){
  const pages = Array.from(document.querySelectorAll('#manga-pages .page'));
  const top = window.scrollY + 72;
  let best = 1, bestDelta = Infinity;
  for (const el of pages){
    const rect = el.getBoundingClientRect();
    const y = rect.top + window.scrollY;
    const delta = Math.abs(y - top);
    if (delta < bestDelta){
      bestDelta = delta;
      best = parseInt(el.dataset.page || '1', 10) || 1;
    }
  }
  return best;
}
function throttle(fn, ms){
  let t=0;
  return (...args)=>{
    const now=Date.now();
    if (now - t >= ms){ t = now; fn(...args); }
  };
}

/* ===== LOGIN FLOW ===== */
function showLogin(){
  const overlay = $('login-overlay');
  overlay.style.display = 'flex';
  overlay.setAttribute('aria-hidden','false');
  document.body.style.overflow='hidden';
  setTimeout(()=>{ const i=$('login-input'); if(i) i.focus(); }, 50);
}
function hideLoginAndRemove(){
  const overlay = $('login-overlay');
  if (!overlay) return;
  overlay.parentNode.removeChild(overlay); // remove kh·ªèi DOM ƒë·ªÉ kh√¥ng ch·∫Øn n·ªØa
  document.body.style.overflow='';
}
function validatePass(pw){ return (pw || '') === PASSWORD; }
function handleLoginSubmit(){
  const val = ($('login-input')?.value || '').trim();
  if (validatePass(val)){
    setCookie('manga_login','1',365);
    hideLoginAndRemove();
    afterLoginInit();
  } else {
    location.href = 'https://www.youtube.com/';
  }
}

/* ===== UI kh·ªüi t·∫°o (login) ===== */
document.addEventListener('DOMContentLoaded', () => {
  // events cho login
  $('login-submit').addEventListener('click', handleLoginSubmit);
  $('login-input').addEventListener('keydown', (e)=>{ if(e.key==='Enter') handleLoginSubmit(); });
  $('login-youtube').addEventListener('click', ()=> location.href='https://www.youtube.com/');

  // check cookie
  if (getCookie('manga_login') === '1'){ hideLoginAndRemove(); afterLoginInit(); }
  else { showLogin(); }
});

/* ===== Kh·ªüi t·∫°o giao di·ªán sau khi login h·ª£p l·ªá ===== */
function afterLoginInit(){
  if (__appInitialized) return;   // guard ƒë·ªÉ kh√¥ng init 2 l·∫ßn
  __appInitialized = true;

  renderList();

  $('prev-chap').addEventListener('click', ()=> goToChap(currentChap-1));
  $('next-chap').addEventListener('click', ()=> goToChap(currentChap+1));
  $('next-chap-bottom').addEventListener('click', ()=> goToNextChap()); // N√∫t cu·ªëi trang
  $('chap-select').addEventListener('change', e=> goToChap(parseInt(e.target.value)));
  $('data-saver').addEventListener('change', () => { MAX_CONCURRENCY = $('data-saver').checked ? 2 : 4; });

  $('to-top').addEventListener('click', () => $('chapter-top').scrollIntoView({behavior:'smooth'}));
  $('to-bottom').addEventListener('click', () => window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'}));
  window.addEventListener('scroll', () => {
    $('floater').classList.toggle('hidden', window.scrollY < 400 || $('reading-page').classList.contains('hidden'));
    if (!$('reading-page').classList.contains('hidden') && currentTruyen){ throttledSave(); }
  });

  // Ph·ª•c h·ªìi ti·∫øn ƒë·ªô ƒë·ªçc n·∫øu c√≥ (tr·ª´ khi b·∫°n v·ªÅ Trang ch·ªß ƒë√£ xo√°)
  const state = loadProgress();
  if (state){
    const tr = truyenList.find(x => x.ten === state.truyen);
    if (tr){ openTruyen(tr, {restore: state}); return; }
  }
}

const throttledSave = throttle(()=>{
  const page = getVisiblePageApprox();
  saveProgress({ truyen: currentTruyen?.ten, chap: currentChap, page });
}, 1000);

/* ===== Trang ch·ªß ===== */
function renderList() {
  const listEl = $('truyen-list');
  listEl.innerHTML = '';
  truyenList.forEach(t => {
    const card = document.createElement('div');
    card.className = 'truyen-card';
    card.innerHTML = `
      <img src="${BASE}${t.cover}" alt="${t.ten}" onerror="this.src='https://via.placeholder.com/200x260?text=·∫¢nh+b√¨a'">
      <h3>${t.ten}</h3><p style="padding:0 10px 12px;opacity:.7">${t.soChap} ch∆∞∆°ng</p>`;
    card.addEventListener('click', () => openTruyen(t));
    listEl.appendChild(card);
  });
}

function openTruyen(t, opts={}) {
  currentTruyen = t; currentChap = 1;
  $('truyen-list').classList.add('hidden');
  $('reading-page').classList.remove('hidden');
  document.querySelector('header h1').textContent = `üìñ ${t.ten}`;

  const sel = $('chap-select'); sel.innerHTML = '';
  for (let i=1;i<=t.soChap;i++){
    const o = document.createElement('option');
    o.value = i; o.textContent = `Ch∆∞∆°ng ${i}`; sel.appendChild(o);
  }

  if (opts.restore && typeof opts.restore.chap === 'number'){
    startChapter(opts.restore.chap, {restorePage: opts.restore.page || 1});
  } else {
    sel.value = 1;
    startChapter(1);
  }
}

/* Khi b·∫•m Trang ch·ªß: xo√° ti·∫øn ƒë·ªô => reload sau ƒë√≥ s·∫Ω KH√îNG v√†o ch·ªó ƒë·ªçc d·ªü */
function goHome() {
  clearProgress(); /* <<< quan tr·ªçng */
  $('reading-page').classList.add('hidden');
  $('truyen-list').classList.remove('hidden');
  document.querySelector('header h1').textContent = 'üìñ Web ƒê·ªçc Truy·ªán';
  currentTruyen = null;
}

/* ===== ƒê·ªçc chap (cu·ªôn d·ªçc + lazy) ===== */
async function startChapter(ch, opts={}){
  if (!currentTruyen) return;
  if (ch < 1 || ch > currentTruyen.soChap) return;
  currentChap = ch;
  $('chap-select').value = ch;
  $('chapter-title').textContent = `${currentTruyen.ten} - Ch∆∞∆°ng ${ch}`;
  $('manga-pages').innerHTML = '';
  $('page-indicator').textContent = 'Trang 0';
  endReached = false; nextToDiscover = 1; discoveredCount = 0;

  const pat = await detectPattern(currentTruyen.folder, ch);
  if (!pat) {
    $('manga-pages').innerHTML = `<div class="page"><div class="skel"></div><p style="color:#c33">Kh√¥ng t√¨m th·∫•y trang 1 c·ªßa chap.</p></div>`;
    return;
  }

  for (let i = 0; i < DISCOVER_AHEAD; i++) spawnNextPlaceholder(pat);

  let sentinel = $('sentinel');
  if (!sentinel) {
    sentinel = document.createElement('div');
    sentinel.id = 'sentinel';
    sentinel.style.height = '1px';
    $('manga-pages').appendChild(sentinel);
  }

  const ioMore = new IntersectionObserver((entries)=>{
    if (entries.some(e => e.isIntersecting)) {
      for (let i = 0; i < 2; i++) spawnNextPlaceholder(pat);
    }
  }, {rootMargin: '1200px 0px'});
  ioMore.observe(sentinel);

  if (opts.restorePage && Number.isFinite(opts.restorePage)){
    await ensurePageExists(pat, opts.restorePage);
    scrollToPage(opts.restorePage);
    saveProgress({ truyen: currentTruyen.ten, chap: currentChap, page: opts.restorePage });
  } else {
    window.scrollTo({top:0, behavior:'instant'});
  }
}

function spawnNextPlaceholder(pat){
  if (endReached) return;
  const p = nextToDiscover++;
  const holder = document.createElement('div');
  holder.className = 'page';
  holder.dataset.page = String(p);
  const sk = document.createElement('div'); sk.className = 'skel';
  holder.appendChild(sk);
  const sentinel = $('sentinel');
  $('manga-pages').insertBefore(holder, sentinel || null);
  lazyLoad(holder, pat);
}

function lazyLoad(holder, pat){
  const io = new IntersectionObserver(async (entries, obs) => {
    if (!entries[0].isIntersecting) return;
    obs.unobserve(holder);
    await loadOne(holder, pat);
  }, {rootMargin: '600px 0px'});
  io.observe(holder);
}

async function loadOne(holder, pat){
  if (endReached || inFlight >= MAX_CONCURRENCY) {
    setTimeout(()=>loadOne(holder, pat), 180);
    return;
  }
  const page = parseInt(holder.dataset.page, 10);
  const src = pageUrl(currentTruyen.folder, currentChap, page, pat);

  inFlight++;
  const ok = await probe(src, {timeoutMs: 12000, retries: 2});
  inFlight--;

  if (!ok) {
    if (page === 1) holder.innerHTML = `<p style="color:#c33">Kh√¥ng t·∫£i ƒë∆∞·ª£c trang 1.</p>`;
    endReached = true;
    return;
  }

  const img = new Image();
  img.loading = 'lazy';
  img.decoding = 'async';
  img.fetchPriority = discoveredCount < 2 ? 'high' : 'low';
  img.alt = `Trang ${page}`;
  img.src = src;
  img.onerror = () => { img.replaceWith(document.createTextNode('L·ªói t·∫£i ·∫£nh.')); };

  holder.innerHTML = '';
  holder.appendChild(img);

  discoveredCount++;
  $('page-indicator').textContent = `Trang ${discoveredCount}`;
}

/* === Ph·ª•c h·ªìi/ƒëi·ªÅu h∆∞·ªõng t·ªõi trang N === */
function scrollToPage(p){
  const el = document.querySelector(`#manga-pages .page[data-page="${p}"]`);
  if (el){
    const y = el.getBoundingClientRect().top + window.scrollY - 70;
    window.scrollTo({top: y, behavior: 'instant'});
  }
}
async function ensurePageExists(pat, targetPage, maxWaitMs = 8000){
  const start = Date.now();
  while (!document.querySelector(`#manga-pages .page[data-page="${targetPage}"]`)) {
    if (endReached) break;
    spawnNextPlaceholder(pat);
    if (Date.now() - start > maxWaitMs) break;
    await new Promise(r=>setTimeout(r, 120));
  }
}

/* ===== ƒêi·ªÅu h∆∞·ªõng chap ===== */
function goToChap(n){ startChapter(n); }
function goToPrevChap(){ if (currentChap>1) startChapter(currentChap-1); }
function goToNextChap(){ if (currentTruyen && currentChap < currentTruyen.soChap) startChapter(currentChap+1); }
</script>
</body>
</html>