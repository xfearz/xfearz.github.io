<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Trang ƒê·ªçc Truy·ªán</title>
  <style>
    :root { --primary:#2d89ef; --bg:#f7f7f7; --text:#333; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: Arial, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:var(--bg); color:var(--text); }
    header { background:var(--primary); color:#fff; padding:15px 60px; text-align:center; position:sticky; top:0; z-index:10; }
    main { padding:16px; display:flex; flex-wrap:wrap; gap:20px; justify-content:center; min-height:calc(100vh - 160px); }
    .truyen-card { width:200px; background:#fff; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,.2); overflow:hidden; text-align:center; cursor:pointer; transition:.2s; }
    .truyen-card:hover { transform:translateY(-4px); box-shadow:0 6px 16px rgba(0,0,0,.25); }
    .truyen-card img { width:100%; height:260px; object-fit:cover; display:block; }
    .truyen-card h3 { padding:10px; font-size:16px; margin:0; }
    footer { background:var(--primary); color:#fff; text-align:center; padding:10px; margin-top:auto; }
    .reading-container { width:100%; max-width:1000px; margin:0 auto; padding:8px; }
    .chapter-controls { display:grid; grid-template-columns: 1fr auto 1fr; align-items:center; gap:10px; margin-bottom:12px; background:#fff; padding:10px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,.08); position:sticky; top:64px; z-index:9; }
    .left,.right { display:flex; gap:8px; align-items:center; }
    .right { justify-content:flex-end; }
    .chapter-controls select, .chapter-controls button, .chapter-controls label { padding:8px 12px; border:1px solid #ddd; border-radius:6px; background:#fff; font-size:15px; cursor:pointer; }
    .chapter-title { text-align:center; margin:6px 0 12px; font-size:22px; }
    .manga-page { width:100%; margin:8px 0; text-align:center; }
    .manga-page img { max-width:100%; height:auto; border-radius:6px; box-shadow:0 4px 8px rgba(0,0,0,.2); background:#eee; }
    .page-controls { display:flex; justify-content:center; gap:20px; margin:16px 0 30px; }
    .hidden { display:none; }
    .error-message { color:#c62828; text-align:center; padding:20px; }
    .tip { text-align:center; font-size:13px; color:#666; margin-top:8px; }
    .badge { font-size:12px; padding:4px 8px; border-radius:999px; background:#eef; color:#234; }
    /* Floating tools */
    .floater {
      position: fixed; right: 16px; bottom: 16px; z-index: 20;
      display: flex; flex-direction: column; gap: 10px;
    }
    .float-btn {
      border: none; border-radius: 999px; padding: 10px 14px;
      background: #fff; color: var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,.2);
      cursor: pointer; font-weight: 600;
    }
    .float-btn:hover { filter: brightness(0.98); }
  </style>
</head>
<body>
  <header>
    <h1>üìñ Web ƒê·ªçc Truy·ªán</h1>
    <button class="home-btn" onclick="goHome()">Trang ch·ªß</button>
  </header>

  <main>
    <div id="truyen-list"></div>

    <div id="reading-page" class="hidden">
      <div class="reading-container">
        <div class="chapter-controls" id="chapter-top">
          <div class="left">
            <button id="prev-chap">Chap tr∆∞·ªõc</button>
            <select id="chap-select"></select>
            <button id="next-chap">Chap sau</button>
          </div>
          <div class="center"><span id="page-indicator" class="badge">Trang 0/0</span></div>
          <div class="right">
            <label title="Lu√¥n cu·ªôn d·ªçc"><input type="checkbox" id="scroll-mode" checked disabled> Cu·ªôn d·ªçc</label>
          </div>
        </div>
        <h2 class="chapter-title" id="chapter-title"></h2>
        <div id="manga-pages"></div>
        <div class="page-controls hidden" id="pager">
          <button id="prev-page">Trang tr∆∞·ªõc</button>
          <button id="next-page">Trang sau</button>
        </div>
        <p class="tip">M·∫πo: D√πng &uarr;&darr; ƒë·ªÉ cu·ªôn nhanh. Nh·∫•n ‚ÄúL√™n ƒë·∫ßu chap‚Äù ƒë·ªÉ quay l·∫°i ph·∫ßn ch·ªçn chap.</p>
      </div>
    </div>
  </main>

  <div class="floater hidden" id="floater">
    <button class="float-btn" id="to-top">‚§¥ L√™n ƒë·∫ßu chap</button>
    <button class="float-btn" id="to-bottom">‚§µ Xu·ªëng cu·ªëi chap</button>
  </div>

  <footer><p>Made with ‚ù§Ô∏è by xFear</p></footer>

  <script>
    // ====== Base path (GitHub Pages) ======
    const BASE = (() => {
      const p = location.pathname;
      return p.endsWith('/') ? p : p.replace(/[^/]+$/, '');
    })();

    // ====== Config truy·ªán ======
    const truyenList = [
      { ten: "Manhwa1", folder: "Manhwa1", cover: "Manhwa1/bg.jpg", soChap: 97 }
    ];

    // ====== State ======
    let currentTruyen = null, currentChap = 1;
    let appendedPages = 0;           // s·ªë trang ƒë√£ g·∫Øn v√†o DOM
    let stopAtPageNotFound = false;  // ƒë√°nh d·∫•u khi g·∫∑p trang l·ªói
    const chapPattern = new Map();   // 'plain' | 'backslash'

    // ====== Helpers ======
    const pageURL = (folder, chap, page, pattern) =>
      pattern === 'backslash'
        ? `${BASE}${folder}/Chap${chap}/Chap${chap}%5C${page}.jpg`
        : `${BASE}${folder}/Chap${chap}/${page}.jpg`;

    function tryLoadFirstPageDetectPattern(folder, chap) {
      // th·ª≠ 2 URL ·ª©ng vi√™n cho trang 1: plain r·ªìi backslash
      return new Promise(resolve => {
        const plain = pageURL(folder, chap, 1, 'plain');
        const back  = pageURL(folder, chap, 1, 'backslash');

        const img = new Image();
        img.onload = () => resolve('plain');
        img.onerror = () => {
          const img2 = new Image();
          img2.onload = () => resolve('backslash');
          img2.onerror = () => resolve(null);
          img2.src = back;
        };
        img.src = plain;
      });
    }

    function appendPage(folder, chap, page, pattern, onSuccess, onFail) {
      const wrap = document.getElementById('manga-pages');
      const img = new Image();
      img.loading = 'lazy';
      img.alt = `Trang ${page}`;
      img.src = pageURL(folder, chap, page, pattern);
      img.onload = () => {
        const d = document.createElement('div');
        d.className = 'manga-page';
        d.appendChild(img);
        wrap.appendChild(d);
        onSuccess && onSuccess();
      };
      img.onerror = () => onFail && onFail();
    }

    function startProgressiveLoad(folder, chap, pattern) {
      appendedPages = 0;
      stopAtPageNotFound = false;
      const indicator = document.getElementById('page-indicator');
      const wrap = document.getElementById('manga-pages');
      wrap.innerHTML = ''; // KH√îNG hi·ªán "ƒêang d√≤ trang"

      // T·∫£i tu·∫ßn t·ª±: 1,2,3,... ƒë·∫øn khi g·∫∑p trang l·ªói th√¨ d·ª´ng
      const loadNext = (p) => {
        if (stopAtPageNotFound) return;
        appendPage(folder, chap, p, pattern,
          () => { // success
            appendedPages++;
            indicator.textContent = `Trang ${appendedPages}/${appendedPages}`;
            // preload ti·∫øp
            loadNext(p + 1);
          },
          () => { // not found -> d·ª´ng
            stopAtPageNotFound = true;
            if (appendedPages === 0) {
              wrap.innerHTML = '<div class="error-message">Kh√¥ng t√¨m th·∫•y trang n√†o trong chap n√†y.</div>';
              indicator.textContent = 'Trang 0/0';
            } else {
              indicator.textContent = `Trang 1‚Äì${appendedPages}/${appendedPages}`;
            }
          }
        );
      };

      // b·∫Øt ƒë·∫ßu t·ª´ 1
      loadNext(1);
    }

    // ====== Init & UI ======
    document.addEventListener('DOMContentLoaded', () => {
      renderTruyenList();
      document.getElementById('prev-chap').addEventListener('click', () => goToPrevChap());
      document.getElementById('next-chap').addEventListener('click', () => goToNextChap());
      document.getElementById('chap-select').addEventListener('change', e => goToChap(parseInt(e.target.value)));
      document.getElementById('to-top').addEventListener('click', () => {
        document.getElementById('chapter-top').scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
      document.getElementById('to-bottom').addEventListener('click', () => {
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
      });
      window.addEventListener('scroll', () => {
        const floater = document.getElementById('floater');
        floater.classList.toggle('hidden', window.scrollY < 400 || document.getElementById('reading-page').classList.contains('hidden'));
      });
    });

    function renderTruyenList(){
      const list = document.getElementById('truyen-list'); list.innerHTML = '';
      truyenList.forEach(t => {
        const card = document.createElement('div'); card.className = 'truyen-card';
        card.innerHTML = `
          <img src="${BASE}${t.cover}" alt="${t.ten}" onerror="this.src='https://via.placeholder.com/200x260?text=·∫¢nh+b√¨a'">
          <h3>${t.ten}</h3><p>${t.soChap} ch∆∞∆°ng</p>`;
        card.addEventListener('click', () => openTruyen(t));
        list.appendChild(card);
      });
    }

    function openTruyen(t){
      currentTruyen = t; currentChap = 1;
      document.getElementById('truyen-list').classList.add('hidden');
      document.getElementById('reading-page').classList.remove('hidden');
      document.querySelector('header h1').textContent = `üìñ ${t.ten}`;
      const sel = document.getElementById('chap-select'); sel.innerHTML = '';
      for (let i=1;i<=t.soChap;i++){ const o=document.createElement('option'); o.value=i; o.textContent=`Ch∆∞∆°ng ${i}`; if(i===1) o.selected=true; sel.appendChild(o); }
      loadChap(1);
    }

    function goHome(){
      document.getElementById('reading-page').classList.add('hidden');
      document.getElementById('truyen-list').classList.remove('hidden');
      document.querySelector('header h1').textContent = 'üìñ Web ƒê·ªçc Truy·ªán';
      currentTruyen = null;
    }

    async function loadChap(ch){
      if (!currentTruyen) return;
      currentChap = ch;
      document.getElementById('chap-select').value = ch;
      document.getElementById('chapter-title').textContent = `${currentTruyen.ten} - Ch∆∞∆°ng ${ch}`;
      document.getElementById('page-indicator').textContent = 'Trang 0/0';

      // Ph√°t hi·ªán pattern ch·ªâ 1 l·∫ßn b·∫±ng trang 1, KH√îNG hi·ªÉn th·ªã loading
      let pattern = chapPattern.get(ch) || null;
      if (!pattern) {
        pattern = await tryLoadFirstPageDetectPattern(currentTruyen.folder, ch);
        if (!pattern) {
          const wrap = document.getElementById('manga-pages');
          wrap.innerHTML = '<div class="error-message">Kh√¥ng t√¨m th·∫•y trang n√†o trong chap n√†y.</div>';
          return;
        }
        chapPattern.set(ch, pattern);
      }

      startProgressiveLoad(currentTruyen.folder, ch, pattern);
      window.scrollTo({top:0, behavior:'instant'});
    }

    function goToPrevChap(){ if (currentChap>1) loadChap(currentChap-1); }
    function goToNextChap(){ if (currentTruyen && currentChap < currentTruyen.soChap) loadChap(currentChap+1); }
    function goToChap(n){ if (n>=1 && n<=currentTruyen.soChap) loadChap(n); }
  </script>
</body>
</html>